I"!ä<h1 id="introduction">Introduction</h1>

<p>This post is written to serve as the minimal starting point, including basic concepts and ready-to-run code snippets, for you when integrating Weights &amp; Biases (I will call it W&amp;B after all) into your machine learning workflow.</p>

<p>As you can notice from the word ‚Äúminimal‚Äù, this post is just a very condensed summary covering only a small portion of the entire W&amp;B documentation. Therefore, I highly encourage you to check out <a href="https://docs.wandb.ai/">the full documentation</a> to learn more after finishing this.</p>

<p>In a nutshell, W&amp;B is <strong>a tool for experiment tracking, dataset versioning, and model management</strong> which we, ML researchers / engineers, do twenty-four-seven. If you are already familiar with TensorBoard, I bet you can easily get most of the contents and start writing codes immediately. Even if you aren‚Äôt, W&amp;B is quite straightforward to use yet incredibly powerful, so I strongly recommend you to take some time and go over this material (it won‚Äôt take that long!).</p>

<p>For explanation, and to give you a sense of adopting W&amp;B in real-world ML projects, I will use my implementation of <em>PointNet (PointNet: Deep Learning on Point Sets for 3D Classification and Segmentation, Charles R. Qi et al., CVPR 2017)</em> as an exempler. Note that all code snippets in this post are from my <a href="https://github.com/DveloperY0115/torch-pointnet"><em>torch-pointnet</em> repository</a>.</p>

<h1 id="initializing-wb">Initializing W&amp;B</h1>

<h2 id="sign-up--sign-in">Sign Up &amp; Sign In</h2>

<p>Don‚Äôt have an account for Weights &amp; Biases? You can easily make one, or directly link your Github account to it.</p>

<p>After signing up, you need to install <em>wandb</em> module to your Python environment. Everything we wil do after all assumes that you‚Äôve installed this module successfully. And in fact, this module is all you need. Installation is surprisingly simple - just run the following command in your shell.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>pip <span class="nb">install </span>wandb
wandb login
</code></pre></div></div>

<h2 id="starting-a-new-run">Starting a New Run</h2>

<p>If you have experience with TensorBoard, you would remember that we need to initialize a <em>SummaryWriter</em> object which is then used for logging throughout the rest of your program. W&amp;B has no difference, but is more elegant in some sense compared to TensorBoard. Running a single line of code will do everything for us.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="c1"># imports
# import torch, numpy, etc
</span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="c1"># ...
</span>
<span class="c1"># def main():
# bla bla bla
</span>
<span class="c1"># and many other functions
# bla bla bla
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	
	<span class="c1"># initialize W&amp;B
</span>	<span class="n">wandb</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s">"torch-pointnet"</span><span class="p">)</span>

	<span class="c1"># run main function
</span>	<span class="n">main</span><span class="p">()</span>
<span class="sb">``</span><span class="err">`</span>

<span class="n">The</span> <span class="n">above</span> <span class="n">code</span> <span class="n">snippet</span> <span class="n">shows</span> <span class="n">the</span> <span class="n">overall</span> <span class="n">structure</span> <span class="n">of</span> <span class="n">my</span> <span class="o">*</span><span class="n">train</span><span class="p">.</span><span class="n">py</span><span class="o">*</span> <span class="nb">file</span><span class="p">,</span> <span class="n">which</span> <span class="n">defines</span> <span class="n">various</span> <span class="n">control</span> <span class="n">flows</span> <span class="n">involving</span> <span class="n">the</span> <span class="n">training</span> <span class="n">of</span> <span class="n">PointNet</span><span class="p">.</span> <span class="n">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span><span class="p">,</span> <span class="o">*</span><span class="n">wandb</span><span class="o">*</span> <span class="ow">is</span> <span class="n">initialized</span> <span class="n">before</span> <span class="n">running</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">which</span> <span class="n">contains</span> <span class="n">a</span> <span class="n">number</span> <span class="n">of</span> <span class="o">*</span><span class="n">wandb</span><span class="p">.</span><span class="n">log</span><span class="o">*</span> <span class="p">(</span><span class="n">will</span> <span class="n">be</span> <span class="n">explained</span> <span class="n">soon</span><span class="p">)</span> <span class="n">calls</span> <span class="k">for</span> <span class="n">tracking</span> <span class="n">important</span> <span class="n">quantities</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">etc</span><span class="p">)</span> <span class="n">during</span> <span class="n">the</span> <span class="n">experiment</span><span class="p">.</span> 

<span class="c1"># Logging &amp; Model Tracking
</span>
<span class="c1">## Log (Almost) Everything You Want
</span>
<span class="o">*</span><span class="n">wandb</span><span class="p">.</span><span class="n">log</span><span class="o">*</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">function</span> <span class="n">that</span> <span class="n">we</span> <span class="n">use</span> <span class="k">for</span> <span class="n">logging</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">log</span> <span class="n">almost</span> <span class="n">everything</span> <span class="n">you</span> <span class="n">can</span> <span class="n">imagine</span> <span class="ow">in</span> <span class="n">various</span> <span class="n">ML</span> <span class="n">workflows</span> <span class="o">-</span> <span class="n">numbers</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="mi">3</span><span class="n">D</span> <span class="n">data</span><span class="p">,</span> <span class="ow">and</span> <span class="n">much</span> <span class="n">more</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">check</span> <span class="n">the</span> <span class="n">supported</span> <span class="n">types</span> <span class="p">[</span><span class="n">here</span><span class="p">](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="p">.</span><span class="n">wandb</span><span class="p">.</span><span class="n">ai</span><span class="o">/</span><span class="n">guides</span><span class="o">/</span><span class="n">track</span><span class="o">/</span><span class="n">log</span><span class="p">).</span>

<span class="n">In</span> <span class="n">my</span> <span class="n">case</span><span class="p">,</span> <span class="n">I</span> <span class="n">use</span> <span class="n">this</span> <span class="k">for</span> <span class="n">tracking</span><span class="p">:</span>

<span class="o">-</span> <span class="n">Training</span> <span class="n">loss</span>
<span class="o">-</span> <span class="n">Test</span> <span class="n">loss</span>
<span class="o">-</span> <span class="n">Test</span> <span class="n">accuracy</span>
<span class="o">-</span> <span class="n">Visualization</span> <span class="n">of</span> <span class="n">test</span> <span class="n">result</span> <span class="p">(</span><span class="k">for</span> <span class="n">qualitative</span> <span class="n">analysis</span><span class="p">)</span>

<span class="n">For</span> <span class="n">instance</span><span class="p">,</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span> <span class="o">*</span><span class="n">train_one_epoch</span><span class="o">*</span> <span class="n">that</span> <span class="n">carries</span> <span class="n">out</span> <span class="n">optimization</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">I</span> <span class="n">simply</span> <span class="n">write</span><span class="p">:</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="k">def</span> <span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
	
	<span class="c1"># forward propagation
</span>	<span class="c1"># bla bla bla
</span>
	<span class="c1"># back propagation
</span>	<span class="c1"># bla bla bla
</span>
	<span class="c1"># update
</span>	<span class="c1"># bla bla bla
</span>
	<span class="c1"># log data
</span>	<span class="n">wandb</span><span class="p">.</span><span class="n">log</span><span class="p">({</span><span class="s">"Train/Loss"</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
<span class="sb">``</span><span class="err">`</span>

<span class="n">The</span> <span class="n">quantity</span> <span class="n">of</span> <span class="n">interest</span> <span class="ow">is</span> <span class="n">packed</span> <span class="n">into</span> <span class="n">a</span> <span class="n">Python</span> <span class="n">dictionary</span> <span class="k">as</span> <span class="n">a</span> <span class="o">*</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">*</span> <span class="n">pair</span> <span class="n">where</span> <span class="o">**</span><span class="n">the</span> <span class="n">key</span> <span class="n">becomes</span> <span class="n">the</span> <span class="n">title</span> <span class="n">of</span> <span class="n">a</span> <span class="n">plot</span><span class="o">**</span><span class="p">,</span> <span class="ow">and</span> <span class="o">**</span><span class="n">the</span> <span class="n">value</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">metric</span><span class="o">**</span> <span class="n">to</span> <span class="n">be</span> <span class="n">recorded</span><span class="p">.</span> <span class="n">Notice</span> <span class="n">how</span> <span class="n">simply</span> <span class="n">the</span> <span class="n">logging</span> <span class="n">works</span><span class="p">.</span> 

<span class="n">Of</span> <span class="n">course</span><span class="p">,</span> <span class="n">I</span> <span class="n">can</span> <span class="n">put</span> <span class="k">as</span> <span class="n">many</span> <span class="n">kinds</span> <span class="n">of</span> <span class="n">data</span> <span class="n">into</span> <span class="n">a</span> <span class="n">dictionary</span> <span class="ow">and</span> <span class="n">log</span> <span class="n">them</span> <span class="n">at</span> <span class="n">once</span><span class="p">.</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
	
	<span class="c1"># forward propagation
</span>
	<span class="c1"># compute metrics used for testing
</span>
	<span class="c1"># log data
</span>	<span class="n">wandb</span><span class="p">.</span><span class="n">log</span><span class="p">(</span>
        <span class="p">{</span><span class="s">"Test/Loss"</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s">"Test/Accuracy"</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span> <span class="s">"Test/Result"</span><span class="p">:</span> <span class="n">wandb</span><span class="p">.</span><span class="n">Image</span><span class="p">(</span><span class="n">fig</span><span class="p">)},</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
    <span class="p">)</span>
<span class="sb">``</span><span class="err">`</span>

<span class="p">(</span><span class="o">*</span><span class="n">Disclaimer</span><span class="p">:</span> <span class="n">Logging</span> <span class="n">image</span> <span class="n">data</span> <span class="n">isn</span><span class="s">'t working as intended at the time I write this post. I'</span><span class="n">ll</span> <span class="k">try</span> <span class="n">to</span> <span class="n">resolve</span> <span class="n">this</span> <span class="n">issue</span> <span class="n">ASAP</span><span class="p">.)</span><span class="o">*</span>

<span class="n">As</span> <span class="n">a</span> <span class="n">result</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span> <span class="n">this</span> <span class="n">beautiful</span> <span class="n">plot</span> <span class="n">of</span> <span class="n">training</span> <span class="n">loss</span> <span class="n">decreasing</span> <span class="n">nicely</span> <span class="n">over</span> <span class="n">time</span><span class="p">.</span> <span class="n">What</span> <span class="n">makes</span> <span class="n">this</span> <span class="n">even</span> <span class="n">cooler</span> <span class="ow">is</span> <span class="n">that</span> <span class="o">**</span><span class="n">you</span> <span class="n">can</span> <span class="n">check</span> <span class="n">the</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">real</span> <span class="n">time</span> <span class="n">at</span> <span class="n">the</span> <span class="n">control</span> <span class="n">panel</span> <span class="n">through</span> <span class="n">your</span> <span class="n">web</span> <span class="n">browser</span><span class="o">**</span> <span class="p">(</span><span class="n">both</span> <span class="n">PC</span> <span class="ow">and</span> <span class="n">mobile</span><span class="p">)</span> <span class="n">without</span> <span class="n">logging</span> <span class="n">into</span> <span class="n">your</span> <span class="n">remote</span> <span class="n">machine</span><span class="p">.</span>

<span class="o">&lt;</span><span class="n">center</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">img</span> <span class="n">class</span><span class="o">=</span><span class="s">"img-fluid"</span> <span class="n">src</span><span class="o">=</span><span class="s">"/assets/post-images/Introduction_to_W&amp;B/fig1.png"</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">center</span><span class="o">&gt;</span>

<span class="c1">## Anatomy of Your Model with W&amp;B
</span>
<span class="n">Having</span> <span class="n">problem</span> <span class="k">with</span> <span class="n">exploding</span> <span class="p">(</span><span class="ow">or</span> <span class="n">vanishing</span><span class="p">)</span> <span class="n">gradients</span> <span class="ow">and</span> <span class="n">don</span><span class="s">'t know which part~~(s)~~ of your model is ~~(are)~~ in trouble? Using W&amp;B, you can easily diagnose the problem. To make W&amp;B pay attention to the internal of your model, simply wrap the model after initializing it.

~~~python
		
def main():
		# check GPU
    device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")
		
		# model &amp; optimizer, schedulers
    network = PointNetCls().to(device)

    # make W&amp;B track model'</span><span class="n">s</span> <span class="n">gradient</span> <span class="ow">and</span> <span class="n">topology</span>
    <span class="n">wandb</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">log_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">log_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

		<span class="c1"># and the rest of main..
</span></code></pre></div></div>

<p>W&amp;B gives you the freedom of choosing which aspects of your network are going to be tracked. In the snippet above, I decided to record the gradients at all layers of my model every 100 steps and track the computational graph formed during training.</p>

<p>Just like logged metrics, this information will show up in your project dashboard.</p>

<center>
    <img class="img-fluid" src="/assets/post-images/Introduction_to_W&amp;B/fig2.png" />
</center>

<h1 id="check-system-utilization">Check System Utilization</h1>

<p>You might want to check whether you‚Äôre pushing your machine to its limit. Thankfully, W&amp;B automatically tracks various statistics of the system throughout a session - GPU memory usage, power consumption, number of CPU threads in use, etc.</p>

<center>
    <img class="img-fluid" src="/assets/post-images/Introduction_to_W&amp;B/fig3.png" />
</center>

<h1 id="hyperparameter-tuning-with-sweep">Hyperparameter Tuning with Sweep</h1>

<p>Personally, I think this is <strong>the coolest feature of W&amp;B</strong>. W&amp;B provides a powerful yet easy-to-use tool for hyperparameters tuning with fancy visualizations that helps users intuitively compare different combinations of them.</p>

<p>In this example, although my model has only few hyperparameters associated with its structure and training, I‚Äôll try to find the sweet spot for learning rate and batch size.</p>

<p>In order to find the optimal combination of hyperparameters, we need to tell W&amp;B,</p>

<ul>
  <li><strong>which hyperparameters to adjust</strong></li>
  <li><strong>what are the possible values (i.e. explorable space) for such hyperparameters</strong></li>
  <li><strong>which metric we want to opimize further through hyperparameter tuning</strong></li>
</ul>

<h2 id="tell-wb-a-list-of-adjustable-variables">Tell W&amp;B a list of adjustable variables</h2>

<p>In my case, I personally prefer using <em>argparse</em> for tweak variables for training. As you can see at the beginning of my <em>train.py,</em> I store the set of arguments in variable <em>args</em>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Parsing argument"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--beta1"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Beta 1 of Adam optimizer"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--beta2"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Beta 2 of Adam optimizer"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--lr"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Learning rate for optimizer"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--step_size"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Step size of StepLR"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--gamma"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Gamma of StepLR"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--num_epoch"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Number of epochs"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--num_iter"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Number of iteration in one epoch"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--batch_size"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Size of a batch"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--num_worker"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Number of workers for data loader"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--out_dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"out"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Name of the output directory"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s">"--save_period"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Number of epochs between checkpoints"</span>
<span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
</code></pre></div></div>

<p>Then I need to inform W&amp;B what the controllable variables are. All I need to do this is simply passing the set of parsed arguments at the time of initialization. Note that this is one way of doing this, and you can see other methods <a href="https://docs.wandb.ai/guides/sweeps/quickstart">here</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>

    <span class="n">wandb</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s">"torch-pointnet"</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>And in function <em>main</em>, I replace all occurences of <em>args.** to *config[</em>]<em>. Here, the object *config</em> holds the variables that we informed to W&amp;B at initialization.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    
    <span class="n">config</span> <span class="o">=</span> <span class="n">wandb</span><span class="p">.</span><span class="n">config</span>

    <span class="c1"># ...
</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">"beta1"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s">"beta2"</span><span class="p">]),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"lr"</span><span class="p">])</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"step_size"</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"gamma"</span><span class="p">])</span>

		<span class="c1"># ...
</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"batch_size"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"num_worker"</span><span class="p">])</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">"batch_size"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">"num_epoch"</span><span class="p">]),</span> <span class="n">leave</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>

				<span class="c1"># rest of main..
</span></code></pre></div></div>

<h2 id="configure-sweep">Configure Sweep</h2>

<p>Next, I wrote a YAML file to specify the hyperparameters that I want to sweep over, the way how to explore the hyperparameter space, and the set of possible values for each hyperparameter.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">program</span><span class="pi">:</span> <span class="s">train.py</span>
<span class="na">method</span><span class="pi">:</span> <span class="s">grid</span>
<span class="na">metric</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Test/Loss</span>
  <span class="na">goal</span><span class="pi">:</span> <span class="s">minimize</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">lr</span><span class="pi">:</span> 
    <span class="na">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="m">0.1</span>
    <span class="pi">-</span> <span class="m">0.01</span>
    <span class="pi">-</span> <span class="m">0.001</span>
    <span class="pi">-</span> <span class="m">0.0001</span>
  <span class="na">batch_size</span><span class="pi">:</span>
    <span class="na">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="m">32</span>
    <span class="pi">-</span> <span class="m">64</span>
    <span class="pi">-</span> <span class="m">128</span>
    <span class="pi">-</span> <span class="m">256</span>
</code></pre></div></div>

<p>In particular, I‚Äôm telling W&amp;B:</p>

<ul>
  <li>that the training routine is defined at the file <em>train.py</em></li>
  <li>to use ‚Äúgrid‚Äù method (examine all possible combinations of hyperparameter values) for exploration</li>
  <li>to ‚Äúminimize‚Äù the metric ‚ÄúTest/Loss‚Äù. <strong>One important note is that you should log a quantity with name ‚ÄúTest/Loss‚Äù somewhere in the training routine.</strong> And I did it previously in the function <em>run_test</em>.</li>
  <li>variables <em>‚Äúlr‚Äù</em> and <em>‚Äúbatch_size‚Äù</em> are the ones that can be modified for each different run. And each of them has a set of possible values (e.g. learning rate (<em>lr</em>) can be one of 0.1, 0.01, 0.001, 0.0001)</li>
</ul>

<h2 id="initialize--run-sweep">Initialize &amp; Run Sweep</h2>

<p>After setting up a sweep configuration in <em>*.yaml</em> file, run the following command to initialize the sweep:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>wandb sweep <span class="k">*</span>.yaml
</code></pre></div></div>

<p>W&amp;B will automatically set up things for you and give you a <em>sweep ID</em> which specifies that exact sweep to be run. <strong>Copy that and use it in the next step.</strong></p>

<h2 id="launch-agents">Launch Agent(s)</h2>

<p>What makes sweep feature more powerful is that multiple machines or processes can contribute to the same sweep. This means, you can concurrently test different combinations of hyperparameters across your devices or processes in a single machine. As long as you share the same sweep ID, W&amp;B will distribute tasks to agents participating in the sweep and all you have to do is just waiting for the result.</p>

<p>The below image shows the result of each trial in the middle of sweeping (i.e. it was still on going). As soon as you see the plot at the bottom, you will immediately notice that the cases using large learning rate tend to give higher test losses while batch size seems to have no effect on test loss.</p>

<center>
    <img class="img-fluid" src="/assets/post-images/Introduction_to_W&amp;B/fig4.png" />
</center>

<h1 id="summary">Summary</h1>

<p>In this post I briefly introduced only a few of, yet fundamental functionalities of W&amp;B. These include:</p>

<ul>
  <li>How to set up W&amp;B for your project</li>
  <li>Logging metrics and various kinds of data using <em>wandb.log</em></li>
  <li>Analyzing model with <em>wandb.watch</em></li>
  <li>Checking statistics of system usages collected by W&amp;B</li>
  <li>Sweep - a powerful way of tuning hyperparameters &amp; visualizing results to gain insights</li>
</ul>

<p>I hope this post was helpful &amp; comprehensible to you, would be glad if you can benefit from it, work in more productive way. Furthermore, as I mentioned in the introduction, be sure to check out the official documentation for more details and things that were not covered here.</p>
:ET