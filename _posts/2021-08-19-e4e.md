---
layout: post
title: "Summary of 'Designing an Encoder for StyleGAN Image Manipulation'"
subtitle: "Designing an Encoder for StyleGAN Image Manipulation (SIGGRAPH 2021)"
background: '/assets/post-images/e4e/fig1.png'
---

# Motivations

<img class="img-fluid" src="/assets/post-images/e4e/fig1.png">
<span class="caption text-muted">Figure 1. <b>Real image editing via StyleGAN inversion using the proposed method in this paper</b>.</span>

- Applying pretrained unconditional generators (e.g. GANs) on real image editing is still an on-going problem as it requires the inversion of the images (to be edited) into the appropriate latent space. Therefore, a high-quality inversion scheme is necessary for such editing techniques.
- High-quality inversion is characterized by two aspects: (1) *reconstruction* of input image from its latent code encoded by the encoder, (2) *editability* achieved by leveraging the editing capabilities of the latent space to obtain meaningful and realistic edits of the input image.
- The quality of reconstruction can be evaluated by measuring two properties: *distortion* (per-image input-output similarity) and *perceptual quality* (how realistic the reconstructed image is). Ideally, the lower the distortion and the higher the perceptual quality is the better.
- However, it turns out that the three quantities - distortion, perceptual quality, and editability - are closely related to each other. And the trade-off between these three should be analyzed thoroughly.

# Key Contributions

- Analyzes the complex latent space of StyleGAN and suggests a novel view of its structure.
- Presents the innate tradeoffs among distortion, perception, and editability.
- Characterizes the tradeoffs and design two means for an encoder to control them.
- Presents *e4e*, a novel encoder specifically designed to allow for the subsequent editing of inverted real images.

---

# TL;DR

This paper proposes a novel approach for GAN inversion by designing an encoder along with training schemes that guide the encoder to embedd images into StyleGAN's latent space. Also, this paper provides thorough  analysis on the trade-offs among the quantities that are directly related to the quality of decoded images - distortion, perceptual quality, and editability. 

# Methods

## Terminology

Briefly speaking, StyleGAN is a model consists of two key components:

1. A mapping function that maps a latent code $\textbf{z} \in \mathcal{Z} = \mathcal{N} (\mu, \sigma^{2})$ into a *style code $\textbf{w} \in \mathcal{W} \subsetneq \mathbb{R}^{512}$,*
2. A generator (synthesis network) which takes the style code, replicated several times, as input, and generates an image.

From now on, the distribution $\mathcal{W}$ will be called the *range* of the mapping function.

It has been empirically shown that a single latent vector is not powerful enough to represent an image that is inverted into StyleGAN's latent space. To circumvent such issue, one possible solution for it is to introduce more latent vectors, say $k$ number of them, different from each other. Then the space obtained by extension can be denoted by $\mathcal{W}^{k} \subsetneq \mathbb{R}^{k \times 512}$ where $k$ is the number of style inputs of the generator.

<img class="img-fluid" src="/assets/post-images/e4e/fig2.png">
<span class="caption text-muted">Figure 2. <b>An illustration of different latent spaces in 1D and 2D</b>.</span>

We can push the boundary of expressiveness even further by inputting style codes that are not from the true distribution of $\mathcal{W}$. Such extension can be achieved by either taking a single style code and replicate it over the blocks of StyleGAN, or taking $k$ different individual codes. Such codes are denoted by $\mathcal{W}\_{\*}$ and $\mathcal{W}\_{*}^{k}$, respectively.

Finally, the characteristics of different latent spaces can be summarized as follows:

<img class="img-fluid" src="/assets/post-images/e4e/table1.png">
<span class="caption text-muted">Table 1. <b>A concise summary outlining the differenes between various latent spaces</b>.</span>

## The GAN Inversion tradeoffs

### Preliminaries

Most of the research on StyleGAN's latent code can be categorized into two tasks: *GAN inversion* and *latent space manipulation*.

In previous works, the two tasks were considered as follows.

1. *GAN inversion*: Given an image $x$, infer a latent code $\textbf{w}$ which is then decoded by the generator to reconstruct the input as closely as possible.
2. *Latent space manipulation*: Given a latent code $\textbf{w}$, infer a new latent code $\textbf{w}^{\prime}$, such that the image $G(\textbf{w}^{\prime})$ synthesized by decoding the code is an image which can be obtained by applying semantically meaningful modification to $G(\textbf{w})$.

In fact, inverting GAN alone has less practical significance compared to that of editing images by controlling their corresponding latent vectors. **What one could do with the network that takes an image and only outputs (ideally) complete replica of the input?** 

Similarily, image manipulation by exploiting latent space would be useless if edited images are not realistic when perceived by ourselves. **Who wants an image editor that introduces too much distortions (or noises) as you modify certain aspect of images?** Therefore, the desirable way is to find the sweet spot that will enable us to modify images in while keeping them visually plausible.

Therefore, the GAN inversion methods should be evaluated by taking both reconstruction and editability into account.

In this work, the reconstruction is assumed to have two distinct properties - *distortion* and *perceptual quality*. Distortion is rigorously defined as $\mathbb{E}\_{x \sim p\_{X}}[\Delta (x, G(\textbf{w}))]$  where $p_{X}$ is the distribution of the real images, and $\Delta(x, G(\textbf{w}))$ is an image-space difference measure (often $\ell_{1}$ or $\ell_{2}$) between images $x$ and $G(\textbf{w})$. On the other hand, perceptual quality measures how realistic the reconstructed images are.

Speaking of editability, it is desirable to have latent space where one can find latent space directions corresponding to disentangled semantic edits in the image-space. At the same time, modifications introduced by exploring such latent space should not harm the perceptual quality of the output images.

### Distortion-Editability & Distortion-Perception Trade-offs

Let us analyze the distortion, perceptual quality, and editability of different regions in StyleGAN's latent space. As mentioned previously, $\mathcal{W}_{*}^{k}$ differs from $\mathcal{W}$ in two ways. Specifically:

1. $\mathcal{W}_{*}^{k}$ may contain different style codes at different style-modulation layers.
2. Each individual style code is not bound to the true distribution of $\mathcal{W}$, but can take any value from $\mathbb{R}^{512}$.

Several studies on the properties of such spaces reveal that $\mathcal{W}_{*}^{k}$ achieves lower (i.e. better) distortion than $\mathcal{W}$. Moreover, the authors found that $\mathcal{W}$ is more editable. The observation is illustrated in the figure below. Evidently, there is inherent trade-off between distortion and editability.

<img class="img-fluid" src="/assets/post-images/e4e/fig3.png">
<span class="caption text-muted">Figure 3. <b>The editability gap between different latent spaces</b>.</span>

Since StyleGAN is originally trained in the $\mathcal{W}$ space, it is not a surprise that $\mathcal{W}$ is more well-behaved and has better perceptual quality compared to its $\mathcal{W}\_{\*}^{k}$ counterpart. In contrast, note that the higher dimensionality of $\mathcal{W}\_{\*}^{k}$ and the structure of StyleGAN gave $\mathcal{W}\_{\*}^{k}$ greater expressive power.

<img class="img-fluid" src="/assets/post-images/e4e/fig4.png">
<span class="caption text-muted">Figure 4. <b>An example of the distortion-perception trade-off</b>.</span>

The authors claim that the distortion-editability and the distortion-perception trade-offs also exist within the $\mathcal{W}\_{\*}^{k}$. Furthermore, the trade-offs are controlled by the proximity to $\mathcal{W}$. Precisely, as $\mathcal{W}\_{\*}^{k}$ gets closer to $\mathcal{W}$, the distortion worsens while the editability and perceptual quality improve. That being said, it is desirable to find means those would allow one to control the proximity of an encoded image to $\mathcal{W}$. From the next section, we will discuss two principles and mechanisms for controlling this proximity.

## Designing an encoder

Learned from the several observations, this paper present principles for designing an encoder and novel training scheme to explicitly address the proximity to $\mathcal{W}$ While there are two mainstreams of GAN inversion methodologies: (i) latent code optimization, (ii) encoder-based methods, this paper focuses on the latter for several reasons:

1. Encoder-based methods are way more faster as they infer a latent code with a single forward pass. → optimization based methodologies are expensive since they work in per-image basis.
2. Due to the piece-wise smoothness of CNNs, the output of an encoder lies in a tight space that is more suitable for editing. → an optimization based inversion may encode an image to an arbitrary point in the latent space.

From now on, we will be discussing the two principles for controlling the proximity to $\mathcal{W}$, where each is defined using a dedicated training paradigm to encourage the encoder to map into regions in $\mathcal{W}_{*}^{k}$ that lie close to $\mathcal{W}$. Moreover, these principles were found to be most effective when applied jointly.

### Minimize Variation (from $\mathcal{W}$)

One way to get closer to $\mathcal{W}$ is to encourage the inferred $\mathcal{W}\_{\*}^{k}$ latent codes to lie closer to $\mathcal{W}\_{\*}$. In other words, we should minimize the variance between the different style codes. To this end, the authors propose a novel 'progressive' training scheme.

Let $E(x) = (\textbf{w}\_{0}, \textbf{w}\_{1}, \dots, \textbf{w}\_{N-1})$ denote the output of the encoder, where $N$ is the number of style-modulation layers. Encoders are normally trained directly into $\mathcal{W}\_{\*}^{k}$, that is, they learn each $\textbf{w}\_{i}$ separately and simultaneously. Apart from such approach, this paper suggests to infer a single latent code, namely $\textbf{w}$, and a set of offsets from $w$. Formally, the encoder will learn to output a collection of latent codes of form $E(x) = (\textbf{w}, \textbf{w} + \Delta_{1}, \dots, \textbf{w} + \Delta_{N-1})$.

Specifically, $\Delta_{i}$'s are initialized to zero at the beginning and the encoder is trained to infer a single $\mathcal{W}\_{\*}$ code. Then the network is gradually allowed to learn a different $\Delta_{i}$ for each $i$ sequentially. This allows the encoder to gradually expand from $\mathcal{W}\_{\*}$ towards $\mathcal{W}_{*}^{k}$. Recalling the structure of StyleGAN's synthesis network and the semantic meaning of each input layer of it, the proposed training scheme allows the encoder to first learn a coarse reconstruction of the input image and then to gradually refine it by optimizing the offset vectors.

The authors observed that low frequency details greatly affect the distortion quality. Therefore, the suggested progressive training scheme can be thought to be doing the following: 

<img class="img-fluid" src="/assets/post-images/e4e/fig5.png">
<span class="caption text-muted">Figure 5. <b>Another illustration of latent spaces in 1D and 2D</b>. Moving along the direction of red arrow (toward diagonal line) brings a latent vector closer to $\mathcal{W}\_{\*}$, while the directions of blue arrows are the paths to get closer to the distribution $\mathcal{W}^{2}$.</span>

> "It first focuses on improving the low frequency distortion by tuning the coarse-level offsets, and then it gradually improves the offsets corresponding to higher frequency details over time."

With the visual aid of figure 5, this process is equivalent to starting from a style code lying on the main diagonal and then slightly diverging from it by allowing small perturbations. **Keep in mind that the encoder outputs offset vectors not latents directly.**

To explicitly enforce a proximity to $\mathcal{W}\_{\*}$, the authors added an $L_{2}$ delta-regularization loss:

$$\mathcal{L}\_{\text{d-reg}} (w) = \sum_{i=1}^{N-1} \Vert \Delta_{i} \Vert_{2}.$$

### Minimize Deviation From $\mathcal{W}^{k}$

Another way to make latents get closer to $\mathcal{W}$ is to encourage the $\mathcal{W}\_{\*}^{k}$ latent codes obtained by the encoder to lie closer to $\mathcal{W}^{k}$. We can achieve this by enforcing the individual style codes to lie within the actual distribution of $\mathcal{W}$. To this end, the authors use a *latent discriminator* trained in an adversarial manner to discriminate between real samples from the $\mathcal{W}$ space and the encoder's learned latent codes.

Guided by such latent discriminator, the encoder will learn to infer latent codes lying in $\mathcal{W}$ as opposed to $\mathcal{W}\_{\*}$. This paper uses a single latent discriminator, denoted $D_{\mathcal{W}}$, which operates on each latent code entry separately. The discriminator iterates over every inferred latent code $E(x)_{i}$ computing the GAN loss for each of them. We then simply take the average over all $i$-s.

Precisely, the form of used GAN loss (non-saturating GAN loss with $R_{1}$ regularization) is as follows:

$$
\begin{gather}
\mathcal{L}_{\text{adv}}^{D} = - \underset{\textbf{w} \sim \mathcal{W}}{\mathbb{E}} [\log D_{\mathcal{W}}(\textbf{w})] - \underset{x \sim p_{X}}{\mathbb{E}} [\log (1 - D_{\mathcal{W}} (E(x)_{i}))] + \\ \frac{\gamma}{2} \underset{\textbf{w} \sim \mathcal{W}}{\mathbb{E}} \Big[ \Vert \nabla_{\textbf{w}} D_{\mathcal{W}} (\textbf{w}) \Vert_{2}^{2} \Big], \\
\mathcal{L}_{\text{adv}}^{E} = - \underset{x \sim p_{X}}{\mathbb{E}} [\log D_{\mathcal{W}}(E(x)_{i})].
\end{gather}
$$

## e4e: Encoder for Editing

<img class="img-fluid" src="/assets/post-images/e4e/fig6.png">
<span class="caption text-muted">Figure 6. <b>The overall structure of e4e network</b>.</span>

The high-level design of the encoder is illustrated above. The encoder denoted *e4e* (*"Encoder for Editing",* reflecting its purpose), builds upon the Pixel2Style2Pixel (pSp) encoder. Unlike the original pSp encoder that generates $N$ style codes at the same time, as described earlier, *e4e* generates a single base style code, denoted by $w$, along with a series of $N-1$ offset vectors. These offsets are then summed up with the base style code $w$ to yield the final $N$ style codes which are now ready to be fed into the fixed, pre-trained StyleGAN2 generator. 

### Losses

In the following section, we will go over each loss adopted for specific purpose. Briefly speaking, we need losses that are able to:

- lower the distortion, by keeping the input and output images to be similar
- increase the perceptual quality and editability by encouraging the generated style codes to remain close to $\mathcal{W}$

**< Distortion >**

To control the distortion introduced by the encoder, this paper borrows one of the key ideas presented in pSp: the identity loss.

Originally, the identity loss is designed to assist the accurate inversion of real images in the facial domain. The authors push this further and generalize it, and end up introducing a novel $\mathcal{L}_{\text{sim}}$ loss defined as:

$$\mathcal{L}_{\text{sim}} (x) = 1 - \langle C(x), C(G(e4e(x))) \rangle,$$

where $C$ is a ResNet-50 model trained with MOCOv2 dataset and $G$ is the pretrained StyleGAN2 generator. This loss encourages the model to predict latent codes that will be decoded to an image whose feature embedding has high cosine similarity with that of the original image. One powerful aspect of $\mathcal{L}_{\text{sim}}$ is that it can be applied to any image domain thanks to the general nature of the extracted features. *(Disclaimer: For facial domain, the authors used the original identity loss as in pSp, and employed a pre-trained ArcFace facial recognition network in the place of ResNet-50.)*

On top of that, the commonly used $\mathcal{L}\_{2}$ and $\mathcal{L}\_{\text{LPIPS}}$ losses are appended to learn both pixel-wise and perceptual similarities. Finally, the distortion loss is defined as:

$$\mathcal{L}\_{\text{dist}} (x) = \lambda_{l2} \mathcal{L}\_{2} (x) + \lambda\_{\text{LPIPS}} \mathcal{L}\_{\text{LPIPS}} (x) + \lambda\_{\text{sim}} \mathcal{L}\_{\text{sim}} (x).$$

**< Perceptual quality and editability >**

Keeping the inferred latent space proximate to StyleGAN's range $\mathcal{W}$ is the key to increase the perceptual quality and editability. To do so, this paper employs the two losses discussed earlier:

1. A delta-regularization loss to ensure proximity to $\mathcal{W}\_{*}$ when learning the offsets $\Delta\_{i}$
2. An adversarial loss using the latent discriminator that encourages each learned style code to lie within the distribution $\mathcal{W}$.

To summarize, the loss for ensuring high perceptual quality and editability is defined as:

$$\mathcal{L}\_{\text{edit}} (x) = \lambda\_{\text{d-reg}} \mathcal{L}\_{\text{d-reg}} (x) + \lambda\_{\text{adv}} \mathcal{L}\_{\text{adv}}(x),$$

where $\mathcal{L}\_{\text{d-reg}}$ and $\mathcal{L}\_{\text{adv}}$ are defined as in the previous section.

**< Total loss >**

At last, the overall loss is defined as a weighted (linear) combination of the distortion and editability losses:

$$\mathcal{L} (x) = \mathcal{L}\_{\text{dist}} (x) + \lambda\_{\text{edit}} \mathcal{L}\_{\text{edit}} (x).$$

# Evaluation

<img class="img-fluid" src="/assets/post-images/e4e/fig7.png">
<span class="caption text-muted">Figure 7. <b>A triplets of a source image, its inversion, and an edit applied on the inverted image across multiple domains</b>.</span>

Speaking of evaluation, there is no doubt that this is challenging. The goal is a proper evaluation method which can evaluate a trade-off between distortion and two other qualities - perceptual quality and editability. Every single one of them is hard to evaluate since they are perceptual in essence, thus objectively measuring & numericalizing these is non-trivial task.

It is worth noting that there are several widely used methods for evaluating perceptual quality. These methods measure the discrepancy between the real and generated distributions using algorithms, listing few of them here:

- FID (Frechet Inception Distance)
- SWD (Sliced Wasserstein Distance)
- IS (Inception Score)

However these methods have some drawbacks:

1. Do not always agree with human perception
2. Affected by distortion

In the case of editability, evaluation becomes even more difficult task since the quality of an edited image should be evaluated as a function of the magnitude of the change introduced by editing. Moreover, qualitative measures often tend to be biased.

For evaluation, the following methods were used:

## Distortion

- $L_{2}$ reconstruction loss
- $\text{LPIPS}$

## Perceptual quality

To quantitatively evaluate the results, the authors measured:

- FID
- SWD

between the distributions of the real and reconstructed images.

## Editability

<img class="img-fluid" src="/assets/post-images/e4e/fig8.png">
<span class="caption text-muted">Figure 8. <b>Inversion followed by a series of edits</b>. Note that D is the configuration which uses the complete e4e method.</span>

We previously defined editability as the ability to perform latent-space editing using any arbitrary technique while maintaining high-visual quality of the image obtained using the edited latent code.

**For editing, the authors first used their GAN inversion method followed by several existing editing techniques such as:**

---

- **StyleFlow**: *R. Abdal, P. Zhu, N. Mitra, and P. Wonka. Styleflow: Attribute-conditioned exploration of stylegan-generated im- ages using conditional continuous normalizing flows, 2020.*
- **InterFaceGAN**: *Y. Shen, J. Gu, X. Tang, and B. Zhou. Interpreting the latent space of gans for semantic face editing.*
- **GANSpace**: *E. H¨ark¨onen, A. Hertzmann, J. Lehtinen, and S. Paris. Ganspace: Discovering interpretable gan controls.*
- **SeFa**: *Y. Shen and B. Zhou. Closed-form factorization of latent semantics in gans.*

---

After performing inversion, the authors applied the listed techniques to edit the code to introduce semantic modifications such as pose, gender, and age for the human facial domain. This modified code is then passed to StyleGAN to generate images. These images are evaluated using FID and SWD. Note that FID and SWD are applied differently in the previous section:

1. Perceptual quality: FID (or SWD) measured by computing the discrepancy between real and *reconstructed* images
2. Editability: FID (or SWD) but measured by computing the discrepancy between real (original) and *edited* images

## Latent Editing Consistency

<img class="img-fluid" src="/assets/post-images/e4e/fig9.png">
<span class="caption text-muted">Figure 9. <b>An illustration of the Latent Editing Consistency.</span>

Apart from the existing evaluation metrics, the authors present a new evaluation metric, called *latent editing consistency* (LEC) which combines two key components of GAN inversion methods meant for latent space editing:

1. A component for capturing the extent for which the inversion matches the true inverse of the generator.
2. Another component for capturing how well-behaved the edits of the inversion outputs are.

And the distance measured in the latent space for quantifying LEC can be defined as the following:

$$\text{LEC}(f\_{\theta}) = \underset{x}{\mathbb{E}} \Vert E(x) - f^{-1}\_{\theta} (E(G(f\_{\theta}(E(x)))))\Vert_{2},$$

where $E$ is an encoder and $f_{\theta}(w)$ is an invertible semantic latent editing function parametrized by $\theta$. The purpose of doing the inverse editing is to let LEC capture how the inherent inversion errors translate to errors in the subsequent editing. In the optimal case, a well-behaved encoder should yield a small LEC difference in the latent space.

# Conclusion

In this work, the authors analyzed the structure of StyleGAN's latent space, a very huge and complex space, in the context of GAN inversion literature. Based on several observations, this paper proposes a novel encoder architecture which can transform a natural image into a proper latent vector lying in the latent space of StyleGAN. At the same time, the authors suggest clever training strategies that better encourage the encoder to learn such behavior. On top of that, the authors validate the encoder by conducting several user studies as well as computing evaluation metrics including the novel method introduced by themselves.